<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Web</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px; margin: 2rem auto; padding: 0 1rem;
            line-height: 1.6;
        }
        h1 { color: #333; }
        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover, .upload-area.dragover {
            background: #f0f8f0;
            border-color: #2E7D32;
        }
        .hidden { display: none; }
        #status {
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .loading { background: #FFF3CD; color: #856404; }
        .success { background: #D4EDDA; color: #155724; }
        .error { background: #F8D7DA; color: #721C24; }
        #result {
            white-space: pre-wrap;
            padding: 1rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            margin-top: 1rem;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
<h1>üé§ Whisper Web</h1>
<p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é.</p>

<div class="upload-area" id="dropzone">
    <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</p>
    <p><small>(–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ)</small></p>
    <input type="file" id="fileInput" accept="audio/*,video/*" class="hidden">
</div>

<button id="transcribeBtn" disabled>–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button>
<div id="status" class="hidden"></div>
<div id="result"></div>

<script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    let transcriber = null;
    let selectedFile = null;

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const transcribeBtn = document.getElementById('transcribeBtn');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    function showStatus(msg, type = 'loading') {
        statusEl.textContent = msg;
        statusEl.className = type;
        statusEl.classList.remove('hidden');
    }

    function hideStatus() {
        statusEl.classList.add('hidden');
    }

    async function initModel() {
        if (transcriber) return transcriber;

        showStatus('‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å whisper-tiny (75 –ú–ë)...');
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –¢–û–õ–¨–ö–û –∏–∑ CDN, –±–µ–∑ –ø–æ–ø—ã—Ç–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            transcriber = await pipeline(
                'automatic-speech-recognition',
                'Xenova/whisper-tiny',
                {
                    cache_dir: undefined, // –æ—Ç–∫–ª—é—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
                    progress_callback: (data) => {
                        if (data.status === 'downloading') {
                            const pct = ((data.loaded / data.total) * 100).toFixed(1);
                            showStatus(`‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${pct}%`);
                        }
                    }
                }
            );
            showStatus('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
            setTimeout(hideStatus, 1000);
            return transcriber;
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', err);
            showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å'}`, 'error');
            throw err;
        }
    }

    async function transcribeAudio(audioBuffer) {
        // –†–µ—Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ 16 –∫–ì—Ü –º–æ–Ω–æ
        const offlineCtx = new OfflineAudioContext(1, audioBuffer.duration * 16000, 16000);
        const source = offlineCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(offlineCtx.destination);
        source.start();
        const renderedBuffer = await offlineCtx.startRendering();
        const audioData = renderedBuffer.getChannelData(0);

        showStatus('üé§ –†–∞—Å–ø–æ–∑–Ω–∞—é —Ä–µ—á—å...');

        const result = await transcriber(audioData, {
            chunk_length_s: 30,
            stride_length_s: 5,
            language: 'ru',
            task: 'transcribe'
        });

        return result.text;
    }

    async function transcribe() {
        if (!selectedFile) return;

        try {
            showStatus('üéµ –î–µ–∫–æ–¥–∏—Ä—É—é –∞—É–¥–∏–æ...');
            transcribeBtn.disabled = true;

            const audioContext = new AudioContext();
            const arrayBuffer = await selectedFile.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const model = await initModel();
            const text = await transcribeAudio(audioBuffer);

            resultEl.textContent = text;
            showStatus('‚úÖ –ì–æ—Ç–æ–≤–æ!', 'success');
            setTimeout(hideStatus, 2000);

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:', err);
            showStatus(`‚ùå ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        } finally {
            transcribeBtn.disabled = false;
        }
    }

    function handleFileSelect(file) {
        selectedFile = file;
        transcribeBtn.disabled = false;
        resultEl.textContent = '';
        showStatus(`–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}`, 'success');
        setTimeout(hideStatus, 1500);
    }

    // UI —Å–æ–±—ã—Ç–∏—è
    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => e.target.files.length && handleFileSelect(e.target.files[0]));
    transcribeBtn.addEventListener('click', transcribe);

    ['dragover', 'dragenter'].forEach(evt => {
        dropzone.addEventListener(evt, (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'));
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
    });
</script>
</body>
</html>