<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Web</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px; margin: 2rem auto; padding: 0 1rem;
            line-height: 1.6;
        }
        h1 { color: #333; }
        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover, .upload-area.dragover {
            background: #f0f8f0;
            border-color: #2E7D32;
        }
        .hidden { display: none; }
        #status {
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .loading { background: #FFF3CD; color: #856404; }
        .success { background: #D4EDDA; color: #155724; }
        .error { background: #F8D7DA; color: #721C24; }
        .warning { background: #FFF3CD; color: #856404; }
        #result {
            white-space: pre-wrap;
            padding: 1rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            margin-top: 1rem;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        progress {
            width: 100%;
            height: 20px;
            margin: 0.5rem 0;
            display: none;
        }
        progress.visible {
            display: block;
        }
        .disclaimer {
            font-size: 0.9rem;
            color: #666;
            margin-top: 1rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<h1>üé§ Whisper Web</h1>
<p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é.</p>

<div class="upload-area" id="dropzone">
    <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</p>
    <p><small>(–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ)</small></p>
    <input type="file" id="fileInput" accept="audio/*,video/*" class="hidden">
</div>

<div class="disclaimer">
    ‚ö†Ô∏è <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong><br>
    ‚Ä¢ –§–∞–π–ª—ã –¥–æ 50 –ú–ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ<br>
    ‚Ä¢ –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (>100 –ú–ë) –º–æ–≥—É—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è<br>
    ‚Ä¢ –î–ª—è YouTube: —Å–∫–∞—á–∞–π—Ç–µ –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ yt-dlp –∏–ª–∏ –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä
</div>

<button id="transcribeBtn" disabled>–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button>

<progress id="progressBar" value="0" max="100"></progress>

<div id="status" class="hidden"></div>
<div id="result"></div>

<script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    let transcriber = null;
    let selectedFile = null;

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const transcribeBtn = document.getElementById('transcribeBtn');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const progressBar = document.getElementById('progressBar');

    function showStatus(msg, type = 'loading') {
        statusEl.textContent = msg;
        statusEl.className = type;
        statusEl.classList.remove('hidden');
    }

    function hideStatus() {
        statusEl.classList.add('hidden');
    }

    function showProgress(value = 0) {
        progressBar.value = value;
        progressBar.classList.add('visible');
    }

    function hideProgress() {
        progressBar.classList.remove('visible');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
    async function initModel() {
        if (transcriber) return transcriber;

        showStatus('‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å whisper-tiny (75 –ú–ë)...');
        showProgress(0);

        try {
            transcriber = await pipeline(
                'automatic-speech-recognition',
                'Xenova/whisper-tiny',
                {
                    cache_dir: undefined,
                    progress_callback: (data) => {
                        if (data.status === 'downloading') {
                            const pct = ((data.loaded / data.total) * 100).toFixed(1);
                            showStatus(`‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${pct}%`);
                            showProgress(parseFloat(pct));
                        }
                    }
                }
            );
            hideProgress();
            showStatus('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
            setTimeout(hideStatus, 1000);
            return transcriber;
        } catch (err) {
            hideProgress();
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', err);
            showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å'}`, 'error');
            throw err;
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ
    async function transcribeAudio(audioBuffer) {
        showProgress(0);
        showStatus('üéµ –†–µ—Å–µ–º–ø–ª–∏—Ä—É—é –∞—É–¥–∏–æ –≤ 16 –∫–ì—Ü...');

        const offlineCtx = new OfflineAudioContext(1, audioBuffer.duration * 16000, 16000);
        const source = offlineCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(offlineCtx.destination);
        source.start();
        const renderedBuffer = await offlineCtx.startRendering();
        const audioData = renderedBuffer.getChannelData(0);

        showStatus('üé§ –†–∞—Å–ø–æ–∑–Ω–∞—é —Ä–µ—á—å...');
        showProgress(30);

        const result = await transcriber(audioData, {
            chunk_length_s: 30,
            stride_length_s: 5,
            language: 'ru',
            task: 'transcribe'
        });

        hideProgress();
        return result.text;
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    async function transcribe() {
        if (!selectedFile) return;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        const maxSize = 100 * 1024 * 1024; // 100 –ú–ë
        if (selectedFile.size > maxSize) {
            if (!confirm(`–§–∞–π–ª ${selectedFile.name} –≤–µ—Å–∏—Ç ${(selectedFile.size / 1024 / 1024).toFixed(1)} –ú–ë.\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –∑–∞–≤–∏—Å–Ω—É—Ç—å.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                return;
            }
        }

        try {
            showStatus('üéµ –î–µ–∫–æ–¥–∏—Ä—É—é –∞—É–¥–∏–æ...');
            transcribeBtn.disabled = true;
            resultEl.textContent = '';

            const audioContext = new AudioContext();
            const arrayBuffer = await selectedFile.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const model = await initModel();
            const text = await transcribeAudio(audioBuffer);

            resultEl.textContent = text;
            showStatus('‚úÖ –ì–æ—Ç–æ–≤–æ!', 'success');
            setTimeout(hideStatus, 2000);

        } catch (err) {
            hideProgress();
            console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:', err);
            showStatus(`‚ùå ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        } finally {
            transcribeBtn.disabled = false;
        }
    }

    function handleFileSelect(file) {
        selectedFile = file;
        transcribeBtn.disabled = false;
        resultEl.textContent = '';

        const sizeMb = (file.size / 1024 / 1024).toFixed(1);
        showStatus(`–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name} (${sizeMb} –ú–ë)`, 'success');

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        if (file.size > 50 * 1024 * 1024) {
            setTimeout(() => {
                showStatus(`‚ö†Ô∏è –§–∞–π–ª –±–æ–ª—å—à–æ–π (${sizeMb} –ú–ë). –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è.`, 'warning');
            }, 1000);
        }

        setTimeout(hideStatus, 2000);
    }

    // UI —Å–æ–±—ã—Ç–∏—è
    dropzone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFileSelect(e.target.files[0]);
    });

    transcribeBtn.addEventListener('click', transcribe);

    ['dragover', 'dragenter'].forEach(evt => {
        dropzone.addEventListener(evt, (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, () => {
            dropzone.classList.remove('dragover');
        });
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            handleFileSelect(e.dataTransfer.files[0]);
        }
    });
</script>
</body>
</html>