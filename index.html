<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Web</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px; margin: 2rem auto; padding: 0 1rem;
            line-height: 1.6;
            background: #f8f9fa;
        }
        h1 { color: #333; margin-bottom: 0.5rem; }
        .subtitle { color: #666; margin-top: 0; margin-bottom: 2rem; }

        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .upload-area:hover, .upload-area.dragover {
            background: #f0f8f0;
            border-color: #2E7D32;
        }
        .hidden { display: none; }

        .disclaimer {
            font-size: 0.9rem;
            color: #666;
            margin-top: 1rem;
            padding: 0.75rem;
            background: #e3f2fd;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
            font-weight: 600;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* Progress steps */
        .progress-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .progress-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: space-between;
        }
        .progress-title .info {
            color: #6c757d;
            font-size: 0.9rem;
            cursor: help;
        }
        .memory-stats {
            font-size: 0.85rem;
            color: #666;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
        }
        .step {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }
        .step:last-child { border-bottom: none; }
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .step-icon.pending { background: #e9ecef; color: #6c757d; }
        .step-icon.active { background: #ffc107; color: #212529; animation: pulse 1.5s infinite; }
        .step-icon.completed { background: #28a745; color: white; }
        .step-icon.skipped { background: #6c757d; color: white; }
        .step-icon.error { background: #dc3545; color: white; }
        .step-content {
            flex: 1;
        }
        .step-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .step-desc {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .step-note {
            font-size: 0.8rem;
            color: #17a2b8;
            margin-top: 0.25rem;
            padding-left: 1.5rem;
            font-style: italic;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(255, 193, 7, 0); }
        }

        /* Status bar */
        #status {
            padding: 0.75rem;
            border-radius: 4px;
            margin: 1rem 0;
            font-weight: 500;
        }
        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        /* Progress bar */
        .progress-bar-container {
            width: 100%;
            background: #e9ecef;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 6px;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Result section */
        .result-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e9ecef;
        }
        .result-title {
            font-weight: 600;
            color: #333;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 0.25rem;
        }
        .metric-label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .result-text {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.05rem;
            color: #495057;
            max-height: 600px;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 1rem;
            font-family: 'Segoe UI', Roboto, monospace;
        }

        /* Live timer */
        .live-timer {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
            padding-left: 1.5rem;
            font-family: monospace;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .spinner-mini {
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Memory warning */
        .memory-warning {
            background: #fff3cd;
            color: #856404;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            display: none;
        }

        /* Debug log */
        .debug-log {
            background: #2d2d2d;
            color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.4;
            display: none;
        }
        .debug-log.show {
            display: block;
        }
        .log-entry {
            margin-bottom: 0.25rem;
            padding-left: 0.5rem;
            border-left: 3px solid #4CAF50;
        }
        .log-entry.info { border-left-color: #2196F3; color: #90CAF9; }
        .log-entry.warn { border-left-color: #FF9800; color: #FFCC80; }
        .log-entry.error { border-left-color: #F44336; color: #EF9A9A; }
        .log-entry.success { border-left-color: #4CAF50; color: #A5D6A7; }
        .log-entry.memory { border-left-color: #9C27B0; color: #CE93D8; }
        .log-time {
            color: #808080;
            margin-right: 0.5rem;
        }
        .toggle-debug {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #6c757d;
            cursor: pointer;
            text-decoration: underline;
        }
        .toggle-debug:hover { color: #007bff; }
    </style>
</head>
<body>
<h1>üé§ Whisper Web</h1>
<p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é</p>

<div class="upload-area" id="dropzone">
    <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</p>
    <p><small>(–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ)</small></p>
    <input type="file" id="fileInput" accept="audio/*,video/*" class="hidden">
</div>

<div class="disclaimer">
    üí° <strong>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:</strong> –†–µ—Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–µ–ª–∏ Whisper ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.<br>
    ‚ö†Ô∏è –§–∞–π–ª—ã –¥–æ 50 –ú–ë: ~1-2 –º–∏–Ω ‚Ä¢ 50-100 –ú–ë: ~2-4 –º–∏–Ω ‚Ä¢ >100 –ú–ë: 5+ –º–∏–Ω (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç CPU)
</div>

<button id="transcribeBtn" disabled>‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</button>

<div id="status" class="hidden"></div>

<div class="progress-container" id="progressContainer" style="display: none;">
    <div class="progress-title">
        <span>üìã –•–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</span>
        <span class="memory-stats" id="memory-stats">RAM: ‚Äî</span>
    </div>

    <div class="step" id="step-model">
        <div class="step-icon pending" id="icon-model">1</div>
        <div class="step-content">
            <div class="step-title">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ Whisper</div>
            <div class="step-desc">–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (~75 –ú–ë)</div>
            <div class="step-details" id="detail-model" style="display: none;"></div>
            <div class="progress-bar-container" id="progress-model" style="display: none;">
                <div class="progress-bar" id="progress-bar-model"></div>
            </div>
        </div>
    </div>

    <div class="step" id="step-decode">
        <div class="step-icon pending" id="icon-decode">2</div>
        <div class="step-content">
            <div class="step-title">–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ</div>
            <div class="step-desc">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏–æ–¥–æ—Ä–æ–∂–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞</div>
            <div class="step-details" id="detail-decode" style="display: none;"></div>
            <div class="live-timer" id="timer-decode" style="display: none;">
                <span class="spinner-mini"></span>
                <span id="timer-text-decode">‚è±Ô∏è –ü—Ä–æ—à–ª–æ: 00:00</span>
            </div>
            <div class="memory-warning" id="memory-warning">
                ‚ö†Ô∏è –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –ø–æ–¥–æ–∂–¥–∏—Ç–µ...
            </div>
        </div>
    </div>

    <div class="step" id="step-resample">
        <div class="step-icon skipped" id="icon-resample">‚äò</div>
        <div class="step-content">
            <div class="step-title">–†–µ—Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="step-desc">–ü—Ä–æ–ø—É—â–µ–Ω–æ ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–µ–ª–∏</div>
            <div class="step-note">‚úÖ Whisper –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤–æ–¥–∏—Ç –∞—É–¥–∏–æ –∫ 16 –∫–ì—Ü –º–æ–Ω–æ</div>
        </div>
    </div>

    <div class="step" id="step-transcribe">
        <div class="step-icon pending" id="icon-transcribe">3</div>
        <div class="step-content">
            <div class="step-title">–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏</div>
            <div class="step-desc">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ –≤ —Ç–µ–∫—Å—Ç</div>
            <div class="step-details" id="detail-transcribe" style="display: none;"></div>
            <div class="progress-bar-container" id="progress-transcribe" style="display: none;">
                <div class="progress-bar" id="progress-bar-transcribe"></div>
            </div>
            <div class="live-timer" id="timer-transcribe" style="display: none;">
                <span class="spinner-mini"></span>
                <span id="timer-text-transcribe">‚è±Ô∏è –ü—Ä–æ—à–ª–æ: 00:00</span>
            </div>
        </div>
    </div>

    <div class="step" id="step-complete">
        <div class="step-icon pending" id="icon-complete">‚úì</div>
        <div class="step-content">
            <div class="step-title">–ì–æ—Ç–æ–≤–æ!</div>
            <div class="step-desc">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>
            <div class="step-details" id="detail-complete" style="display: none;"></div>
        </div>
    </div>
</div>

<div class="debug-log" id="debugLog">
    <div class="log-entry info"><span class="log-time">[00:00:00.000]</span> üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ</div>
</div>
<span class="toggle-debug" id="toggleDebug">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ª–æ–≥–∏</span>

<div class="result-container" id="resultContainer" style="display: none;">
    <div class="result-header">
        <div class="result-title">üìù –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏</div>
        <button id="copyBtn" onclick="copyResult()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div class="metrics">
        <div class="metric-card">
            <div class="metric-value" id="metric-size">-</div>
            <div class="metric-label">–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metric-duration">-</div>
            <div class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metric-chars">-</div>
            <div class="metric-label">–°–∏–º–≤–æ–ª–æ–≤</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metric-words">-</div>
            <div class="metric-label">–°–ª–æ–≤</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metric-time">-</div>
            <div class="metric-label">–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
        </div>
    </div>

    <div class="result-text" id="resultText"></div>
</div>

<script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    let transcriber = null;
    let selectedFile = null;
    let startTime = null;
    let timerInterval = null;
    let logStartTime = Date.now();
    let memoryCheckInterval = null;

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const transcribeBtn = document.getElementById('transcribeBtn');
    const statusEl = document.getElementById('status');
    const progressContainer = document.getElementById('progressContainer');
    const resultContainer = document.getElementById('resultContainer');
    const resultText = document.getElementById('resultText');
    const debugLog = document.getElementById('debugLog');
    const memoryStats = document.getElementById('memory-stats');

    // –®–∞–≥–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const steps = {
        model: { icon: 'icon-model', detail: 'detail-model', progress: 'progress-bar-model', container: 'progress-model' },
        decode: { icon: 'icon-decode', detail: 'detail-decode', timer: 'timer-decode' },
        resample: { icon: 'icon-resample' }, // skipped
        transcribe: { icon: 'icon-transcribe', detail: 'detail-transcribe', progress: 'progress-bar-transcribe', container: 'progress-transcribe', timer: 'timer-transcribe' },
        complete: { icon: 'icon-complete', detail: 'detail-complete' }
    };

    // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
    function log(message, type = 'info') {
        const now = Date.now();
        const elapsed = ((now - logStartTime) / 1000).toFixed(3);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = (elapsed % 60).toFixed(3).padStart(7, '0');
        const timestamp = `[${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds}]`;

        // –ö–æ–Ω—Å–æ–ª—å
        const consoleMsg = `${timestamp} ${message}`;
        if (type === 'error') {
            console.error(consoleMsg);
        } else if (type === 'warn') {
            console.warn(consoleMsg);
        } else if (type === 'success') {
            console.log('%c' + consoleMsg, 'color: green; font-weight: bold;');
        } else {
            console.log(consoleMsg);
        }

        // UI –ª–æ–≥
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `<span class="log-time">${timestamp}</span>${message}`;
        debugLog.appendChild(entry);
        debugLog.scrollTop = debugLog.scrollHeight;
    }

    function logMemory() {
        if (performance.memory) {
            const usedMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
            const totalMB = (performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(1);
            const percent = ((performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit) * 100).toFixed(1);

            memoryStats.textContent = `RAM: ${usedMB} MB (${percent}%)`;

            // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 500 –ú–ë –∏–ª–∏ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 80%
            if (usedMB > 500 || percent > 80) {
                log(`MemoryWarning: ${usedMB} MB / ${totalMB} MB (${percent}%)`, 'warn');
            }

            return { usedMB, totalMB, percent };
        }
        return null;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–≥–∞–º–∏
    function setStep(stepName, status, message = '', progress = 0) {
        const step = steps[stepName];
        const icon = document.getElementById(step.icon);
        const detail = document.getElementById(step.detail);

        icon.className = `step-icon ${status}`;
        if (message && detail) {
            detail.textContent = message;
            detail.style.display = 'block';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        if (step.progress && progress > 0) {
            const progressBar = document.getElementById(step.progress);
            const container = document.getElementById(step.container);
            progressBar.style.width = `${progress}%`;
            container.style.display = 'block';
        }
    }

    // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    function startTimer(timerId, timerTextId) {
        let seconds = 0;
        const timerEl = document.getElementById(timerId);
        const timerText = document.getElementById(timerTextId);
        timerEl.style.display = 'flex';

        timerInterval = setInterval(() => {
            seconds++;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            timerText.textContent = `‚è±Ô∏è –ü—Ä–æ—à–ª–æ: ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ 10 —Å–µ–∫—É–Ω–¥
            if (seconds > 10 && timerId === 'timer-decode') {
                document.getElementById('memory-warning').style.display = 'block';
            }

            // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            if (seconds % 5 === 0) {
                logMemory();
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        document.getElementById('memory-warning').style.display = 'none';
    }

    function showStatus(msg, type = 'loading') {
        statusEl.textContent = msg;
        statusEl.className = type === 'loading' ? 'status-loading' :
            type === 'success' ? 'status-success' :
                type === 'error' ? 'status-error' : 'status-warning';
        statusEl.classList.remove('hidden');
    }

    function hideStatus() {
        statusEl.classList.add('hidden');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
    async function initModel() {
        log('üöÄ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ Whisper', 'info');
        logMemory();

        setStep('model', 'active', '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ CDN...', 0);

        try {
            const modelStart = Date.now();

            transcriber = await pipeline(
                'automatic-speech-recognition',
                'Xenova/whisper-tiny',
                {
                    cache_dir: undefined,
                    progress_callback: (data) => {
                        if (data.status === 'downloading') {
                            const pct = ((data.loaded / data.total) * 100).toFixed(1);
                            const size = (data.total / 1024 / 1024).toFixed(1);
                            const loadedMB = (data.loaded / 1024 / 1024).toFixed(1);
                            setStep('model', 'active', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${pct}% (${loadedMB}/${size} –ú–ë)`, parseFloat(pct));

                            // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π 25%
                            if (pct % 25 === 0) {
                                logMemory();
                            }
                        }
                    }
                }
            );

            const modelEnd = Date.now();
            const modelTime = ((modelEnd - modelStart) / 1000).toFixed(1);
            logMemory();
            log(`‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–∞ ${modelTime} —Å–µ–∫`, 'success');

            setStep('model', 'completed', '–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∞', 100);
            return transcriber;
        } catch (err) {
            setStep('model', 'error');
            log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ${err.message}`, 'error');
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', err);
            throw err;
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –ë–ï–ó —Ä–µ—Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    async function transcribeAudio(audioBuffer) {
        // –®–∞–≥ 2: –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –£–ñ–ï –ó–ê–í–ï–†–®–ï–ù–û
        const channels = audioBuffer.numberOfChannels;
        const sampleRate = audioBuffer.sampleRate;
        const duration = audioBuffer.duration;

        logMemory();
        log(`‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${channels} –∫–∞–Ω–∞–ª(–∞), ${sampleRate} –ì—Ü, ${duration.toFixed(1)} —Å–µ–∫`, 'success');

        setStep('decode', 'completed', `–£—Å–ø–µ—à–Ω–æ: ${channels} –∫–∞–Ω–∞–ª–∞(–æ–≤), ${sampleRate} –ì—Ü, ${duration.toFixed(1)} —Å–µ–∫`);
        stopTimer();

        // –®–∞–≥ 3: –†–µ—Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ü–†–û–ü–£–©–ï–ù (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–µ–ª–∏)
        log('‚äò –†–µ—Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Whisper)', 'info');
        setStep('resample', 'skipped');

        // –®–∞–≥ 4: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ ‚Äî –ø–µ—Ä–µ–¥–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        log('üé§ –ù–∞—á–∞–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏...', 'info');
        setStep('transcribe', 'active', '–ê–Ω–∞–ª–∏–∑ —Ä–µ—á–∏...', 0);
        startTimer('timer-transcribe', 'timer-text-transcribe');

        try {
            // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∫–∞–Ω–∞–ª (–∏–ª–∏ —Å–º–µ—à–∏–≤–∞–µ–º –µ—Å–ª–∏ —Å—Ç–µ—Ä–µ–æ)
            let audioData;
            if (audioBuffer.numberOfChannels > 1) {
                log(`üîÑ –°–º–µ—à–∏–≤–∞–Ω–∏–µ ${audioBuffer.numberOfChannels} –∫–∞–Ω–∞–ª–æ–≤ –≤ –º–æ–Ω–æ...`, 'info');
                const left = audioBuffer.getChannelData(0);
                const right = audioBuffer.getChannelData(1);
                audioData = new Float32Array(left.length);
                for (let i = 0; i < left.length; i++) {
                    audioData[i] = (left[i] + right[i]) / 2;
                }
                log(`‚úÖ –°–º–µ—à–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${audioData.length} —Å—ç–º–ø–ª–æ–≤`, 'success');
            } else {
                audioData = audioBuffer.getChannelData(0);
                log(`‚úÖ –ú–æ–Ω–æ –∞—É–¥–∏–æ: ${audioData.length} —Å—ç–º–ø–ª–æ–≤`, 'success');
            }

            // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
            const chunkLength = duration > 180 ? 15 : (duration > 60 ? 20 : 30);
            log(`‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: —á–∞–Ω–∫=${chunkLength}—Å, —à–∞–≥=${(chunkLength/6).toFixed(1)}—Å`, 'info');

            const transcribeStart = Date.now();

            const result = await transcriber(audioData, {
                chunk_length_s: chunkLength,
                stride_length_s: chunkLength / 6,
                language: 'ru',
                task: 'transcribe',
                return_timestamps: false,
                progress_callback: (data) => {
                    if (data.status === 'processing' && data.current_chunk && data.total_chunks) {
                        const progress = ((data.current_chunk / data.total_chunks) * 100).toFixed(1);
                        setStep('transcribe', 'active',
                            `–û–±—Ä–∞–±–æ—Ç–∫–∞: —Ñ—Ä–∞–≥–º–µ–Ω—Ç ${data.current_chunk}/${data.total_chunks}`,
                            parseFloat(progress));

                        // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π 10-–π —á–∞–Ω–∫
                        if (data.current_chunk % 10 === 0 || data.current_chunk === data.total_chunks) {
                            logMemory();
                            log(`üìä –ß–∞–Ω–∫ ${data.current_chunk}/${data.total_chunks} (${progress}%)`, 'info');
                        }
                    }
                }
            });

            const transcribeEnd = Date.now();
            const transcribeTime = ((transcribeEnd - transcribeStart) / 1000).toFixed(1);

            stopTimer();
            setStep('transcribe', 'completed', `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ ${result.text.length} —Å–∏–º–≤–æ–ª–æ–≤`, 100);
            document.getElementById('timer-transcribe').style.display = 'none';

            logMemory();
            log(`‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ ${transcribeTime} —Å–µ–∫ (${result.text.length} —Å–∏–º–≤–æ–ª–æ–≤)`, 'success');

            return result.text;
        } catch (err) {
            stopTimer();
            setStep('transcribe', 'error');
            log(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${err.message}`, 'error');
            throw err;
        }
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    function copyResult() {
        const text = resultText.textContent;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.getElementById('copyBtn');
            const original = btn.textContent;
            btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                btn.textContent = original;
            }, 2000);
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
        });
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    async function transcribe() {
        if (!selectedFile) return;

        // –°–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        logStartTime = Date.now();
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
        log('üé¨ –ó–ê–ü–£–°–ö –ù–û–í–û–ô –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ò', 'info');
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
        const maxSize = 250 * 1024 * 1024; // 250 –ú–ë
        const fileSizeMB = (selectedFile.size / 1024 / 1024).toFixed(1);

        log(`üìÅ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${selectedFile.name} (${fileSizeMB} –ú–ë)`, 'info');

        if (selectedFile.size > maxSize) {
            log(`‚ö†Ô∏è –§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç ${maxSize/1024/1024} –ú–ë`, 'warn');
            if (!confirm(`‚ö†Ô∏è –§–∞–π–ª ${selectedFile.name} –≤–µ—Å–∏—Ç ${fileSizeMB} –ú–ë.\n–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10+ –º–∏–Ω—É—Ç –∏ –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –æ–±—Ä–∞–±–æ—Ç–∫—É –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞', 'warn');
                return;
            }
            log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ–±—Ä–∞–±–æ—Ç–∫—É –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞', 'success');
        }

        startTime = Date.now();

        // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        Object.keys(steps).forEach(step => {
            const stepConfig = steps[step];
            if (step === 'resample') {
                setStep(step, 'skipped');
            } else {
                setStep(step, step === 'model' ? 'active' : 'pending', '', 0);
            }
            if (stepConfig.container) {
                document.getElementById(stepConfig.container).style.display = 'none';
            }
            if (stepConfig.timer) {
                document.getElementById(stepConfig.timer).style.display = 'none';
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        progressContainer.style.display = 'block';
        resultContainer.style.display = 'none';

        // –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏
        memoryCheckInterval = setInterval(logMemory, 2000);

        try {
            showStatus('üöÄ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...', 'loading');
            transcribeBtn.disabled = true;

            // –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞)
            if (!transcriber) {
                log('üì• –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É...', 'info');
                await initModel();
            } else {
                log('‚úÖ –ú–æ–¥–µ–ª—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (–∫—ç—à)', 'success');
                setStep('model', 'completed', '–ú–æ–¥–µ–ª—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 100);
            }

            // –®–∞–≥ 2: –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ ‚Äî –ü–û–ö–ê–ó–´–í–ê–ï–ú –ß–¢–û –ù–ê–ß–ê–õ–ò
            log('üîä –ù–∞—á–∞–ª–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏–æ...', 'info');
            setStep('decode', 'active', '–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...', 0);
            startTimer('timer-decode', 'timer-text-decode');
            showStatus('üîä –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ... —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤', 'loading');

            const decodeStart = Date.now();

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();
            log(`üîß –°–æ–∑–¥–∞–Ω AudioContext: ${audioContext.sampleRate} –ì—Ü`, 'info');

            log('üì• –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ ArrayBuffer...', 'info');
            const arrayBuffer = await selectedFile.arrayBuffer();
            const arrayBufferSizeMB = (arrayBuffer.byteLength / 1024 / 1024).toFixed(1);
            logMemory();
            log(`‚úÖ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω: ${arrayBufferSizeMB} –ú–ë (${arrayBuffer.byteLength} –±–∞–π—Ç)`, 'success');

            log('üéµ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã—Ö (–≠–¢–û –ú–û–ñ–ï–¢ –ó–ê–ù–Ø–¢–¨ –í–†–ï–ú–Ø)...', 'info');
            logMemory();

            // –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const decodeEnd = Date.now();
            const decodeTime = ((decodeEnd - decodeStart) / 1000).toFixed(1);
            logMemory();
            log(`‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ ${decodeTime} —Å–µ–∫`, 'success');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ü–û–°–õ–ï –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
            if (audioBuffer.duration > 3600) { // > 1 —á–∞—Å
                log(`‚ö†Ô∏è –§–∞–π–ª –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π: ${Math.floor(audioBuffer.duration/60)} –º–∏–Ω—É—Ç`, 'warn');
                stopTimer();
                if (!confirm(`‚ö†Ô∏è –§–∞–π–ª –¥–ª–∏—Ç—Å—è ${Math.floor(audioBuffer.duration/60)} –º–∏–Ω—É—Ç.\n–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–∞–º—è—Ç–∏.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                    log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª–∏–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞', 'warn');
                    setStep('decode', 'pending');
                    return;
                }
                log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª–∏–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞', 'success');
                startTimer('timer-decode', 'timer-text-decode');
            }

            const text = await transcribeAudio(audioBuffer);

            // –®–∞–≥ 5: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            setStep('complete', 'completed', '–í—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');

            // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            resultText.textContent = text;
            resultContainer.style.display = 'block';

            // –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
            updateMetrics(selectedFile, audioBuffer, text);

            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            logMemory();
            log(`üéâ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${elapsed} —Å–µ–∫`, 'success');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');

            showStatus(`‚úÖ –ì–æ—Ç–æ–≤–æ! –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω—è–ª–∞ ${elapsed} —Å–µ–∫`, 'success');

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:', err);
            log(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${err.message}`, 'error');
            log(`   Stack: ${err.stack}`, 'error');
            setStep('complete', 'error');
            showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        } finally {
            transcribeBtn.disabled = false;
            stopTimer();
            if (memoryCheckInterval) {
                clearInterval(memoryCheckInterval);
                memoryCheckInterval = null;
            }
        }
    }

    function updateMetrics(file, audioBuffer, text) {
        // –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
        const size = (file.size / 1024 / 1024).toFixed(1);
        document.getElementById('metric-size').textContent = `${size} –ú–ë`;

        // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        const duration = audioBuffer.duration;
        const mins = Math.floor(duration / 60);
        const secs = Math.floor(duration % 60);
        document.getElementById('metric-duration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        // –°–∏–º–≤–æ–ª—ã
        document.getElementById('metric-chars').textContent = text.length;

        // –°–ª–æ–≤–∞
        const words = text.trim().split(/\s+/).filter(w => w).length;
        document.getElementById('metric-words').textContent = words;

        // –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('metric-time').textContent = `${elapsed} —Å–µ–∫`;
    }

    function handleFileSelect(file) {
        selectedFile = file;
        transcribeBtn.disabled = false;

        // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        Object.keys(steps).forEach(step => {
            if (step === 'resample') {
                setStep(step, 'skipped');
            } else {
                setStep(step, 'pending', '', 0);
            }
        });
        progressContainer.style.display = 'none';
        resultContainer.style.display = 'none';

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        const size = (file.size / 1024 / 1024).toFixed(1);
        showStatus(`‚úÖ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name} (${size} –ú–ë)`, 'success');
        setTimeout(hideStatus, 2000);
    }

    // UI —Å–æ–±—ã—Ç–∏—è
    dropzone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFileSelect(e.target.files[0]);
    });

    transcribeBtn.addEventListener('click', transcribe);

    ['dragover', 'dragenter'].forEach(evt => {
        dropzone.addEventListener(evt, (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, () => {
            dropzone.classList.remove('dragover');
        });
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            handleFileSelect(e.dataTransfer.files[0]);
        }
    });

    // Toggle debug log
    document.getElementById('toggleDebug').addEventListener('click', () => {
        debugLog.classList.toggle('show');
    });

    // Preload model on page load for faster first transcription
    window.addEventListener('load', () => {
        log('üåê –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞—é –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É –º–æ–¥–µ–ª–∏...', 'info');
        showStatus('üì• –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ Whisper (–æ–¥–∏–Ω —Ä–∞–∑)...', 'warning');
        initModel().then(() => {
            hideStatus();
            log('‚úÖ –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
        }).catch(err => {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å:', err);
            log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å: ${err.message}`, 'warn');
            hideStatus();
        });
    });
</script>
</body>
</html>